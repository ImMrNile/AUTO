# üîÑ –§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

```typescript
// –ò–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
const response = await fetch('/api/analytics/sync-background', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    batchSize: 10 // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞ —Ä–∞–∑
  })
});

const { taskId } = await response.json();
console.log('–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—â–µ–Ω–∞:', taskId);
```

### 2. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ñ–æ–Ω–µ

```
–ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏
    ‚Üì
–ë–∞—Ç—á 1 (10 —Ç–æ–≤–∞—Ä–æ–≤)
    ‚îú‚îÄ –¢–æ–≤–∞—Ä 1: –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (15 —Å–µ–∫)
    ‚îú‚îÄ –¢–æ–≤–∞—Ä 2: –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (15 —Å–µ–∫)
    ‚îú‚îÄ ...
    ‚îî‚îÄ –¢–æ–≤–∞—Ä 10: –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (15 —Å–µ–∫)
    ‚Üì
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î ‚úÖ
    ‚Üì
–ó–∞–¥–µ—Ä–∂–∫–∞ 2 –º–∏–Ω—É—Ç—ã
    ‚Üì
–ë–∞—Ç—á 2 (10 —Ç–æ–≤–∞—Ä–æ–≤)
    ‚îú‚îÄ –¢–æ–≤–∞—Ä 11: –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (15 —Å–µ–∫)
    ‚îú‚îÄ ...
    ‚îî‚îÄ –¢–æ–≤–∞—Ä 20: –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (15 —Å–µ–∫)
    ‚Üì
... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ
```

### 3. –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**–î–ª—è 438 —Ç–æ–≤–∞—Ä–æ–≤:**
- –ë–∞—Ç—á–µ–π: 438 / 10 = ~44 –±–∞—Ç—á–∞
- –í—Ä–µ–º—è –Ω–∞ –±–∞—Ç—á: ~2.5 –º–∏–Ω—É—Ç—ã (10 —Ç–æ–≤–∞—Ä–æ–≤ √ó 15 —Å–µ–∫)
- –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏: 2 –º–∏–Ω—É—Ç—ã
- **–û–±—â–µ–µ –≤—Ä–µ–º—è: ~3-4 —á–∞—Å–∞**

### 4. –î–∞–Ω–Ω—ã–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ

```typescript
// UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
const products = await prisma.product.findMany({
  include: {
    analytics: true // –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ –º–µ—Ä–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  }
});

// –ö–∞–∂–¥—ã–µ 2-3 –º–∏–Ω—É—Ç—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –ø–æ –Ω–æ–≤—ã–º 10 —Ç–æ–≤–∞—Ä–∞–º
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI** - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ  
‚úÖ **–°–æ–±–ª—é–¥–∞–µ—Ç rate limits** - –±–æ–ª—å—à–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏  
‚úÖ **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - –¥–∞–Ω–Ω—ã–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry** - Inngest –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö  
‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤ Inngest Dashboard  

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ó–∞–ø—É—Å–∫–∞–π—Ç–µ —Ñ–æ–Ω–æ–≤—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ —á–µ—Ä–µ–∑ cron:

```typescript
// –°–æ–∑–¥–∞–π—Ç–µ Inngest cron —Ñ—É–Ω–∫—Ü–∏—é
export const dailyAnalyticsSync = inngest.createFunction(
  { 
    id: 'daily-analytics-sync',
    name: '–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏'
  },
  { cron: '0 2 * * *' }, // –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00
  async ({ step }) => {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const users = await prisma.user.findMany({
      where: { isActive: true }
    });

    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
    for (const user of users) {
      await inngest.send({
        name: 'analytics/sync.background',
        data: { userId: user.id, batchSize: 10 }
      });
    }
  }
);
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

–î–æ–±–∞–≤—å—Ç–µ –∫–Ω–æ–ø–∫—É –≤ UI:

```typescript
// components/AnalyticsSyncButton.tsx
export function AnalyticsSyncButton() {
  const [syncing, setSyncing] = useState(false);

  const startSync = async () => {
    setSyncing(true);
    try {
      const response = await fetch('/api/analytics/sync-background', {
        method: 'POST'
      });
      const data = await response.json();
      
      toast.success('–§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞!');
      toast.info('–î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 3-4 —á–∞—Å–æ–≤');
    } catch (error) {
      toast.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
    } finally {
      setSyncing(false);
    }
  };

  return (
    <button onClick={startSync} disabled={syncing}>
      {syncing ? '–ó–∞–ø—É—Å–∫...' : '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É'}
    </button>
  );
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤—Ö–æ–¥–µ

```typescript
// app/dashboard/page.tsx
useEffect(() => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –±—ã–ª–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
  const lastSync = localStorage.getItem('lastAnalyticsSync');
  const hoursSinceSync = lastSync 
    ? (Date.now() - parseInt(lastSync)) / (1000 * 60 * 60)
    : 999;

  // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 24 —á–∞—Å–æ–≤ - –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
  if (hoursSinceSync > 24) {
    fetch('/api/analytics/sync-background', { method: 'POST' });
    localStorage.setItem('lastAnalyticsSync', Date.now().toString());
  }
}, []);
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞

```typescript
// –ë–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ —Ä–∞–∑ = –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –±–æ–ª—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ API
await fetch('/api/analytics/sync-background', {
  method: 'POST',
  body: JSON.stringify({ batchSize: 20 }) // –ë—ã–ª–æ 10
});
```

### –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É —Ç–æ–≤–∞—Ä–∞–º–∏

```typescript
// src/lib/inngest/functions/syncAnalytics.ts
const analyticsData = await analyticsService.getBulkProductAnalytics(
  nmIds,
  30,
  20000 // –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 20 —Å–µ–∫—É–Ω–¥ (–±—ã–ª–æ 15)
);
```

### –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏

```typescript
// src/lib/inngest/functions/syncAnalytics.ts
if (batchIndex < batches.length - 1) {
  await step.sleep('wait-between-batches', '5m'); // –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 5 –º–∏–Ω—É—Ç (–±—ã–ª–æ 2)
}
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Inngest Dashboard

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://app.inngest.com
2. –ù–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `sync-analytics-background`
3. –°–º–æ—Ç—Ä–∏—Ç–µ:
   - –¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
   - –°–∫–æ–ª—å–∫–æ –±–∞—Ç—á–µ–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
   - –û—à–∏–±–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –õ–æ–≥–∏

```bash
# –í –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞
üîÑ [Analytics Sync] –ù–∞—á–∞–ª–æ —Ñ–æ–Ω–æ–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è xxx
‚úÖ –ö–∞–±–∏–Ω–µ—Ç –Ω–∞–π–¥–µ–Ω: BAGGS
üì¶ –ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: 438
üìä –†–∞–∑–±–∏—Ç–æ –Ω–∞ 44 –±–∞—Ç—á–µ–π –ø–æ 10 —Ç–æ–≤–∞—Ä–æ–≤
üîÑ –ë–∞—Ç—á 1/44: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è 10 —Ç–æ–≤–∞—Ä–æ–≤
‚úÖ –¢–æ–≤–∞—Ä 447012826: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
...
‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: 438 —É—Å–ø–µ—à–Ω–æ, 0 –æ—à–∏–±–æ–∫
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –í—Å—ë –µ—â—ë 429 –æ—à–∏–±–∫–∏

**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á—å—Ç–µ –∑–∞–¥–µ—Ä–∂–∫–∏:
- –ú–µ–∂–¥—É —Ç–æ–≤–∞—Ä–∞–º–∏: 15 —Å–µ–∫ ‚Üí 20 —Å–µ–∫
- –ú–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏: 2 –º–∏–Ω ‚Üí 5 –º–∏–Ω

### –ü—Ä–æ–±–ª–µ–º–∞: –°–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ

**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á—å—Ç–µ —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞:
- batchSize: 10 ‚Üí 20
- –ù–æ –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å rate limits!

### –ü—Ä–æ–±–ª–µ–º–∞: –î–∞–Ω–Ω—ã–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –ó–∞–ø—É—â–µ–Ω–∞ –ª–∏ –∑–∞–¥–∞—á–∞ –≤ Inngest Dashboard
2. –ï—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö
3. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ª–∏ `lastSyncAt` –≤ –ë–î

## –ò—Ç–æ–≥–∏

‚úÖ **–§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞**  
‚úÖ **–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ**  
‚úÖ **UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î**  
‚úÖ **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**  
‚úÖ **–°–æ–±–ª—é–¥–∞–µ—Ç rate limits WB API**  

**–¢–µ–ø–µ—Ä—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ, –∞ –≤—ã –º–æ–∂–µ—Ç–µ —Å–ø–æ–∫–æ–π–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º!** üéâ
