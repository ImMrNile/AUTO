# Быстрый старт: Работа с товарами Wildberries

## Что было сделано

### ✅ Улучшена система выгрузки товаров
- Добавлены задержки между запросами (200ms) для соблюдения rate limits WB API
- Реализована полная выгрузка данных: цены, остатки, размеры, себестоимость
- Добавлена автоматическая синхронизация с базой данных
- Товары теперь можно загружать из БД без повторных запросов к API

### ✅ Обновлена база данных
Добавлены новые поля в таблицу `products`:
- `wbNmId` - номер товара на WB
- `vendorCode` - артикул продавца
- `brand` - бренд
- `costPrice` - **себестоимость**
- `discountPrice` - цена со скидкой
- `discount` - процент скидки
- `stock` - остаток на складе
- `reserved` - зарезервировано
- `inTransit` - в пути к клиенту
- `inReturn` - возвраты
- `sizes` - размеры с остатками
- `lastWbSyncAt` - время последней синхронизации

### ✅ Обновлен API
**Новый endpoint:** `/api/wb/products`

**Получение товаров из БД (быстро):**
```bash
GET /api/wb/products?source=db
```

**Получение товаров с WB API с синхронизацией:**
```bash
POST /api/wb/products
Content-Type: application/json

{
  "action": "get-products",
  "syncToDb": true
}
```

### ✅ Обновлен фронтенд
Компонент `ProductsWithAnalytics` теперь:
- Показывает полную информацию о товарах
- Отображает себестоимость и прибыль
- Показывает детальные остатки (на складе, в пути, возвраты)
- Поддерживает два режима: загрузка из БД или с WB API

## Как использовать

### 1. Первая загрузка товаров

Откройте страницу "Товары с аналитикой" и:
1. Нажмите кнопку "Товары на WB"
2. Дождитесь загрузки (может занять 1-2 минуты для большого количества товаров)
3. Товары автоматически сохранятся в БД

### 2. Просмотр товаров из БД

1. Нажмите кнопку "Мои товары"
2. Товары загрузятся мгновенно из базы данных
3. Данные будут актуальны на момент последней синхронизации

### 3. Обновление данных

Чтобы обновить данные о товарах:
1. Переключитесь на "Товары на WB"
2. Нажмите "Обновить"
3. Данные обновятся и сохранятся в БД

## Важные данные о товарах

### Цены
- **Цена** - базовая цена товара
- **Цена со скидкой** - актуальная цена для покупателей
- **Скидка** - процент скидки
- **Себестоимость** - рассчитывается как 60% от цены (можно настроить)

### Остатки
- **На складе** - доступно для продажи
- **Зарезервировано** - в заказах, ожидающих отправки
- **В пути к клиенту** - отправлено покупателям
- **Возвраты** - товары в процессе возврата

### Прибыль
Ориентировочная прибыль рассчитывается как:
```
(Цена со скидкой - Себестоимость) × Количество проданных единиц
```

## Настройка себестоимости

По умолчанию себестоимость = 60% от цены.

Чтобы изменить:
1. Откройте файл: `src/app/api/wb/products/route.ts`
2. Найдите строку: `const costPrice = Math.floor(price * 0.6);`
3. Измените коэффициент 0.6 на нужный

Или добавьте возможность ручного ввода себестоимости для каждого товара.

## Автоматическая синхронизация

Рекомендуется настроить автоматическую синхронизацию товаров:

### Вариант 1: Cron job (Linux/Mac)
```bash
# Каждый день в 3:00
0 3 * * * curl -X POST http://your-domain.com/api/wb/products \
  -H "Content-Type: application/json" \
  -d '{"action": "sync-products"}'
```

### Вариант 2: Scheduled task (Windows)
Создайте задачу в планировщике Windows для ежедневного выполнения скрипта синхронизации.

### Вариант 3: Vercel Cron Jobs
Если используете Vercel, добавьте в `vercel.json`:
```json
{
  "crons": [{
    "path": "/api/wb/products/sync",
    "schedule": "0 3 * * *"
  }]
}
```

## Производительность

### Время загрузки
- **Из БД**: < 1 секунда
- **С WB API**: 
  - 10 товаров: ~5 секунд
  - 50 товаров: ~15 секунд
  - 100 товаров: ~30 секунд

### Рекомендации
1. Используйте загрузку из БД для повседневной работы
2. Синхронизируйте с WB API 1-2 раза в день
3. Для большого количества товаров (>100) настройте фоновую синхронизацию

## Устранение проблем

### Товары не загружаются
1. Проверьте API токен в настройках кабинета
2. Убедитесь, что токен имеет права на чтение товаров
3. Проверьте логи в консоли браузера (F12)

### Неполные данные
1. Убедитесь, что товары опубликованы на WB
2. Проверьте, что у товаров есть цены и остатки
3. Некоторые данные могут быть недоступны для определенных категорий

### Медленная загрузка
1. Используйте загрузку из БД вместо WB API
2. Уменьшите количество товаров в одном запросе
3. Настройте фоновую синхронизацию

## Следующие шаги

1. **Настройте себестоимость** для точного расчета прибыли
2. **Настройте автоматическую синхронизацию** для актуальности данных
3. **Используйте данные из БД** для быстрого доступа
4. **Экспортируйте данные** в CSV/JSON для анализа

## Техническая документация

Подробная техническая документация доступна в файле:
`docs/WB-PRODUCTS-IMPROVEMENT.md`

## Поддержка

При возникновении проблем:
1. Проверьте логи в консоли браузера (F12)
2. Проверьте логи сервера
3. Убедитесь, что база данных обновлена (`npx prisma db push`)
