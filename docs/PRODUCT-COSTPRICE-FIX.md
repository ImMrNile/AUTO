# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä–∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑—ã–≤–∞–ª —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ, –Ω–æ –æ–Ω–∞ **–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å** –≤ –ë–î. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–ø–∞–¥–∞–ª–∞.

### –ü—Ä–∏—á–∏–Ω–∞

–í API –¥–µ—Ç–∞–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (`/api/analytics/product-details`) –±—ã–ª–∞ –æ—à–∏–±–∫–∞:

1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞:**
   ```typescript
   // ‚ùå –ë—ã–ª–æ
   where: {
     OR: [
       { wbNmId: nmId },  // nmId –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞–∫ —á–∏—Å–ª–æ, –∞ –≤ –ë–î —Å—Ç—Ä–æ–∫–∞
       { id: nmId }
     ]
   }
   ```
   
2. **–ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤–º–µ—Å—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
   ```typescript
   // ‚ùå –ë—ã–ª–æ
   if (!product?.subcategory) {
     product = await prisma.product.create({
       // –°–æ–∑–¥–∞–≤–∞–ª—Å—è –ù–û–í–´–ô —Ç–æ–≤–∞—Ä –ë–ï–ó costPrice
       // –°—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å —Å costPrice —Ç–µ—Ä—è–ª–∞—Å—å!
     });
   }
   ```

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ—à–∏–±–∫–∏:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª costPrice ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å –≤ –ë–î ‚úÖ
2. –û—Ç–∫—Ä—ã–ª –¥–µ—Ç–∞–ª—å–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É ‚Üí –ø–æ–∏—Å–∫ –Ω–µ –Ω–∞—à–µ–ª —Ç–æ–≤–∞—Ä ‚ùå
3. –°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–ª–∞ –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä –ë–ï–ó costPrice ‚ùå
4. –°—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å —Å costPrice –ø–æ—Ç–µ—Ä—è–ª–∞—Å—å ‚ùå
```

## –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞

**–ë—ã–ª–æ:**
```typescript
where: {
  OR: [
    { wbNmId: nmId },  // ‚ùå –ù–µ –Ω–∞—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ nmId —á–∏—Å–ª–æ
    { id: nmId }
  ]
}
```

**–°—Ç–∞–ª–æ:**
```typescript
where: {
  OR: [
    { wbNmId: String(nmId) },  // ‚úÖ –ü—Ä–∏–≤–æ–¥–∏–º –∫ —Å—Ç—Ä–æ–∫–µ
    { id: nmId }
  ]
}
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞

**–ë—ã–ª–æ:**
```typescript
// –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
product = await prisma.product.create({
  data: { ...data }  // –ë–ï–ó costPrice
});
```

**–°—Ç–∞–ª–æ:**
```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–æ–≤–∞—Ä –≤ –ë–î
const existingProduct = await prisma.product.findFirst({
  where: {
    wbNmId: String(nmId),
    userId: user.id
  }
});

if (existingProduct) {
  // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–≤–∞—Ä
  product = await prisma.product.update({
    where: { id: existingProduct.id },
    data: {
      name: productName || existingProduct.name,
      price: actualPrice || existingProduct.price,
      // costPrice –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ!
    }
  });
} else {
  // ‚úÖ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ–≥–æ —Ç–æ—á–Ω–æ –Ω–µ—Ç
  product = await prisma.product.create({
    data: { ...data }
  });
}
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```typescript
console.log(`üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –≤ –ë–î: nmId=${nmId}, –Ω–∞–π–¥–µ–Ω=${!!product}, costPrice=${product?.costPrice || 0}‚ÇΩ`);
console.log(`‚úÖ –¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –ë–î, costPrice —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ${product.costPrice || 0}‚ÇΩ`);
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å **—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞
‚úÖ –¢–æ–≤–∞—Ä **–Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç—Å—è**, –∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
‚úÖ –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ —Å—Ç—Ä–æ–∫–µ)
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

- `src/app/api/analytics/product-details/route.ts` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –£–∫–∞–∂–∏—Ç–µ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
2. –û—Ç–∫—Ä–æ–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞—Å—å
4. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É - —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è
