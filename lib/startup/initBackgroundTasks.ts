// lib/startup/initBackgroundTasks.ts - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
import { BackgroundTaskProcessor } from '../services/backgroundTaskProcessor';

let isInitialized = false;
let initPromise: Promise<void> | null = null;

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ Next.js —Å–µ—Ä–≤–µ—Ä–∞
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
 */
export async function initBackgroundTasks() {
  if (isInitialized) {
    return;
  }

  // –ï—Å–ª–∏ —É–∂–µ –∏–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –∂–¥–µ–º –µ—ë –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
  if (initPromise) {
    return initPromise;
  }

  isInitialized = true;

  initPromise = (async () => {
    console.log('üöÄ [Startup] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á...');

    try {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
      await BackgroundTaskProcessor.initialize();
      console.log('‚úÖ [Startup] –°–∏—Å—Ç–µ–º–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
    } catch (error) {
      console.error('‚ùå [Startup] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á:', error);
      isInitialized = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      initPromise = null;
    }
  })();

  return initPromise;
}
