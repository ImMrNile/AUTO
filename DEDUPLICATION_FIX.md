# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –Ω–µ–¥–µ–ª—å –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥—É–±–ª–∏—Ä–æ–≤–∞–ª–∏—Å—å. –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, "356956444") –ø–æ—è–≤–ª—è–ª—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö, —á—Ç–æ –∑–∞—Ç—Ä—É–¥–Ω—è–ª–æ –∞–Ω–∞–ª–∏–∑.

**–ü—Ä–∏–º–µ—Ä –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```json
{
  "total": 198,
  "queries": [
    { "text": "356956444", "frequency": { "current": 14 }, ... },
    { "text": "356956444", "frequency": { "current": 35 }, ... },
    { "text": "356956444", "frequency": { "current": 13 }, ... },
    { "text": "493805274", "frequency": { "current": 35 }, ... },
    { "text": "493805274", "frequency": { "current": 1 }, ... }
  ]
}
```

## –ü—Ä–∏—á–∏–Ω–∞
–í —Ñ—É–Ω–∫—Ü–∏–∏ `aggregateCollectedData()` –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –Ω–µ–¥–µ–ª—å –ø—Ä–æ—Å—Ç–æ –æ–±—ä–µ–¥–∏–Ω—è–ª–∏—Å—å –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã:

```typescript
// –ë–´–õ–û:
const allSearchQueries = collectedData.searchQueries;
```

## –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ –ø–æ–ª—é `text` —Å —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –º–µ—Ç—Ä–∏–∫:

```typescript
// –°–¢–ê–õ–û:
const queryMap = new Map<string, any>();

collectedData.searchQueries.forEach((query: any) => {
  const key = query.text;
  if (!queryMap.has(key)) {
    queryMap.set(key, query);
  } else {
    // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É–∂–µ –µ—Å—Ç—å, —Å—É–º–º–∏—Ä—É–µ–º –º–µ—Ç—Ä–∏–∫–∏
    const existing = queryMap.get(key);
    existing.frequency.current = (existing.frequency.current || 0) + (query.frequency.current || 0);
    existing.weekFrequency = (existing.weekFrequency || 0) + (query.weekFrequency || 0);
    existing.openCard.current = (existing.openCard.current || 0) + (query.openCard.current || 0);
    existing.addToCart.current = (existing.addToCart.current || 0) + (query.addToCart.current || 0);
    existing.orders.current = (existing.orders.current || 0) + (query.orders.current || 0);
  }
});

const allSearchQueries = Array.from(queryMap.values());
```

## –õ–æ–≥–∏–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏

1. **–°–æ–∑–¥–∞–µ—Ç—Å—è Map** —Å –∫–ª—é—á–æ–º = `query.text`
2. **–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ—è–≤–ª–µ–Ω–∏–∏** –∑–∞–ø—Ä–æ—Å–∞ - –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ Map
3. **–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –ø–æ—è–≤–ª–µ–Ω–∏–∏** –∑–∞–ø—Ä–æ—Å–∞ - –º–µ—Ç—Ä–∏–∫–∏ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è:
   - `frequency.current` - –æ–±—â–∞—è —á–∞—Å—Ç–æ—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞
   - `weekFrequency` - —á–∞—Å—Ç–æ—Ç–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º
   - `openCard.current` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç–∏–π –∫–∞—Ä—Ç–æ—á–∫–∏
   - `addToCart.current` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–π –≤ –∫–æ—Ä–∑–∏–Ω—É
   - `orders.current` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤

## –†–µ–∑—É–ª—å—Ç–∞—Ç

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```json
{
  "total": 85,
  "queries": [
    { 
      "text": "356956444", 
      "frequency": { "current": 62 },  // –°—É–º–º–∞: 14 + 35 + 13
      "openCard": { "current": 72 },   // –°—É–º–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã
      ...
    },
    { 
      "text": "493805274", 
      "frequency": { "current": 36 },  // –°—É–º–º–∞: 35 + 1
      ...
    }
  ]
}
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏:

```
üìä [Smart Optimization] –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:
   –î–æ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏: 198 –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   –ü–æ—Å–ª–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏: 85 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   –£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: 113
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑  
‚úÖ **–°—É–º–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏** - –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ–±—â—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥  
‚úÖ **–¢–æ—á–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞** - –ª–µ–≥—á–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤  
‚úÖ **–ú–µ–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö** - —É–º–µ–Ω—å—à–µ–Ω —Ä–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ API  

## –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∫–∞–º–ø–∞–Ω–∏–π

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–∞–º–ø–∞–Ω–∏–π - –æ–¥–Ω–∞ –∫–∞–º–ø–∞–Ω–∏—è –º–æ–≥–ª–∞ –ø–æ—è–≤–ª—è—Ç—å—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –Ω–µ–¥–µ–ª—è—Ö.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
const campaignMap = new Map<number, any>();

collectedData.campaignStats.forEach((stats: any) => {
  const statsArray = Array.isArray(stats) ? stats : (stats ? [stats] : []);
  
  statsArray.forEach((campaign: any) => {
    const campaignId = campaign.advertId;
    if (!campaignId) return;
    
    if (!campaignMap.has(campaignId)) {
      campaignMap.set(campaignId, { ...campaign });
    } else {
      // –°—É–º–º–∏—Ä—É–µ–º –º–µ—Ç—Ä–∏–∫–∏
      const existing = campaignMap.get(campaignId);
      existing.views += campaign.views || 0;
      existing.clicks += campaign.clicks || 0;
      existing.orders += campaign.orders || 0;
      existing.sum += campaign.sum || 0;
      
      // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º CTR, CPC, CPM
      if (existing.views > 0) {
        existing.ctr = ((existing.clicks / existing.views) * 100).toFixed(2);
        existing.cpc = existing.clicks > 0 ? (existing.sum / existing.clicks).toFixed(2) : '0';
        existing.cpm = ((existing.sum / existing.views) * 1000).toFixed(2);
      }
    }
  });
});

const allCampaignStats = Array.from(campaignMap.values());
```

**–°—É–º–º–∏—Ä—É–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–∞–º–ø–∞–Ω–∏–π:**
- `views` - –ø—Ä–æ—Å–º–æ—Ç—Ä—ã
- `clicks` - –∫–ª–∏–∫–∏
- `orders` - –∑–∞–∫–∞–∑—ã
- `sum` - —Ä–∞—Å—Ö–æ–¥—ã
- `atbs` - –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
- `shks` - –ø–æ–∫–∞–∑—ã

**–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- `ctr` = (clicks / views) * 100
- `cpc` = sum / clicks
- `cpm` = (sum / views) * 1000

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

- `src/app/api/products/[id]/smart-optimization-data/route.ts`
  - –°—Ç—Ä–æ–∫–∏ 1113-1131: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
  - –°—Ç—Ä–æ–∫–∏ 1181-1213: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π
  - –°—Ç—Ä–æ–∫–∏ 188-206: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —É–º–Ω—ã–π –ø–æ–∏—Å–∫ –¥–ª—è —Ç–æ–≤–∞—Ä–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   ```
   üìä [Smart Optimization] –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:
      –î–æ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏: X –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
      –ü–æ—Å–ª–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏: Y —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
      –£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: Z
   ```
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –∫–∞–∂–¥—ã–π `text` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º
4. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –º–µ—Ç—Ä–∏–∫–∏ —Å—É–º–º–∏—Ä–æ–≤–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–ó–∞–ø—Ä–æ—Å "356956444" –≤—Å—Ç—Ä–µ—á–∞–ª—Å—è –≤ 3 –Ω–µ–¥–µ–ª—è—Ö:**
- –ù–µ–¥–µ–ª—è 1: frequency=14, openCard=17
- –ù–µ–¥–µ–ª—è 2: frequency=35, openCard=40
- –ù–µ–¥–µ–ª—è 3: frequency=13, openCard=15

**–ü–æ—Å–ª–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏:**
- frequency = 14 + 35 + 13 = 62
- openCard = 17 + 40 + 15 = 72

–≠—Ç–æ –¥–∞–µ—Ç –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É –∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥!
