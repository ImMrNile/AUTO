# üîß –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∫ –∫–∞–±–∏–Ω–µ—Ç–∞–º

## ‚úÖ –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. ‚úÖ **–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤—Ä—É—á–Ω—É—é** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫–∞–±–∏–Ω–µ—Ç—É
2. ‚úÖ **–ö–æ–¥ —É–∂–µ –µ—Å—Ç—å** –≤ `src/app/api/products/route.ts`

### –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. ‚ùå **–°—Ç–∞—Ä—ã–µ —Ç–æ–≤–∞—Ä—ã** (—Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–≤—è–∑–∫–∏) - –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã
2. ‚ùå **–ò–º–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å WB** - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∫—É

---

## üéØ –†–µ—à–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ ‚úÖ (—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

```typescript
// src/app/api/products/route.ts (—Å—Ç—Ä–æ–∫–∏ 303-312)
await safePrismaOperation(
  () => prisma.productCabinet.create({
    data: {
      productId: product.id,
      cabinetId: productData.cabinetId, // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      isSelected: true
    }
  }),
  '—Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–∏ —Å –∫–∞–±–∏–Ω–µ—Ç–æ–º'
);
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤

---

### 2. –ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Å WB ‚ö†Ô∏è (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å)

–ù–∞–π–¥–∏—Ç–µ –≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–º–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å Wildberries –∏ –¥–æ–±–∞–≤—å—Ç–µ:

```typescript
// –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∏–∑ WB API
const product = await prisma.product.create({
  data: {
    // ... –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞
  }
});

// ‚úÖ –î–û–ë–ê–í–ò–¢–¨: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–∞–±–∏–Ω–µ—Ç—É
const cabinet = await prisma.cabinet.findFirst({
  where: {
    userId: product.userId,
    isActive: true,
    apiToken: { not: null }
  },
  orderBy: { createdAt: 'asc' }
});

if (cabinet) {
  await prisma.productCabinet.create({
    data: {
      productId: product.id,
      cabinetId: cabinet.id,
      isSelected: true
    }
  });
}
```

---

### 3. Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–∏–≤—è–∑–∫–∏ üÜï

–°–æ–∑–¥–∞–π—Ç–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ª—é–±–æ–≥–æ —Ç–æ–≤–∞—Ä–∞:

```typescript
// lib/services/productCabinetService.ts
export async function ensureProductHasCabinet(productId: string, userId: string) {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø—Ä–∏–≤—è–∑–∫–∞
  const existingLink = await prisma.productCabinet.findFirst({
    where: { productId }
  });
  
  if (existingLink) {
    return; // –£–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω
  }
  
  // –ù–∞–π—Ç–∏ –ø–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å —Ç–æ–∫–µ–Ω–æ–º
  const cabinet = await prisma.cabinet.findFirst({
    where: {
      userId,
      isActive: true,
      apiToken: { not: null }
    },
    orderBy: { createdAt: 'asc' }
  });
  
  if (!cabinet) {
    throw new Error('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º WB API');
  }
  
  // –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É
  await prisma.productCabinet.create({
    data: {
      productId,
      cabinetId: cabinet.id,
      isSelected: true
    }
  });
  
  console.log(`‚úÖ –¢–æ–≤–∞—Ä ${productId} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–∞–±–∏–Ω–µ—Ç—É ${cabinet.name}`);
}
```

–ó–∞—Ç–µ–º –≤—ã–∑—ã–≤–∞–π—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤–µ–∑–¥–µ –≥–¥–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–≤–∞—Ä:

```typescript
// –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
const product = await prisma.product.create({ ... });

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞
await ensureProductHasCabinet(product.id, product.userId);
```

---

## üìã –ì–¥–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —ç—Ç–∏ –º–µ—Å—Ç–∞:

1. ‚úÖ **POST /api/products** - —É–∂–µ –µ—Å—Ç—å
2. ‚ö†Ô∏è **–ò–º–ø–æ—Ä—Ç —Å WB** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
3. ‚ö†Ô∏è **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
4. ‚ö†Ô∏è **Bulk —Å–æ–∑–¥–∞–Ω–∏–µ** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### –§–∞–π–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ –º–µ—Å—Ç–∞ –≥–¥–µ —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–≤–∞—Ä—ã
grep -r "product.create" src/app/api/
grep -r "products.createMany" src/app/api/
```

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–∂–¥–æ–µ –º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ ‚úÖ

**–ü–ª—é—Å—ã:**
- –Ø–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
- –í–∏–¥–Ω–æ –≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏–≤—è–∑–∫–∞

**–ú–∏–Ω—É—Å—ã:**
- –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –∫–∞–∂–¥–æ–µ –º–µ—Å—Ç–æ
- –ú–æ–∂–Ω–æ –∑–∞–±—ã—Ç—å

### –í–∞—Ä–∏–∞–Ω—Ç 2: Prisma Middleware üåü (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–°–æ–∑–¥–∞–π—Ç–µ middleware –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∂–µ—Ç —Ç–æ–≤–∞—Ä –∫ –∫–∞–±–∏–Ω–µ—Ç—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏:

```typescript
// lib/prisma.ts
prisma.$use(async (params, next) => {
  const result = await next(params);
  
  // –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
  if (params.model === 'Product' && params.action === 'create') {
    const product = result;
    
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –ø—Ä–∏–≤—è–∑–∫–∞
    const hasLink = await prisma.productCabinet.findFirst({
      where: { productId: product.id }
    });
    
    if (!hasLink) {
      // –ù–∞–π—Ç–∏ –∫–∞–±–∏–Ω–µ—Ç –∏ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É
      const cabinet = await prisma.cabinet.findFirst({
        where: {
          userId: product.userId,
          isActive: true,
          apiToken: { not: null }
        }
      });
      
      if (cabinet) {
        await prisma.productCabinet.create({
          data: {
            productId: product.id,
            cabinetId: cabinet.id,
            isSelected: true
          }
        });
        
        console.log(`‚úÖ [Middleware] –¢–æ–≤–∞—Ä ${product.id} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑–∞–Ω`);
      }
    }
  }
  
  return result;
});
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –∫–∞–∂–¥–æ–µ –º–µ—Å—Ç–æ
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–±—ã—Ç—å

**–ú–∏–Ω—É—Å—ã:**
- –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞

---

## üöÄ –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å

### –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤:
```bash
# –†–∞–∑–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç (—É–∂–µ –∑–∞–ø—É—â–µ–Ω)
node fix-product-cabinets-v2.mjs
```

### –î–ª—è –Ω–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤:

**–í–∞—Ä–∏–∞–Ω—Ç –ê: –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ**
–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –∏–º–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)

**–í–∞—Ä–∏–∞–Ω—Ç –ë: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ** üåü
–î–æ–±–∞–≤—å—Ç–µ Prisma middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–∏–≤—è–∑–∫–∏

---

## ‚úÖ –ò—Ç–æ–≥

### –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ–±–ª–µ–º –ù–ï –ë–£–î–ï–¢ –µ—Å–ª–∏:

1. ‚úÖ –¢–æ–≤–∞—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É - **—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω middleware - **–±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤–µ–∑–¥–µ**
3. ‚úÖ –ò–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏–≤—è–∑–∫–∞ –≤ –∏–º–ø–æ—Ä—Ç - **–±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ**

### –¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Ç–æ–ª—å–∫–æ —Å:
- ‚ùå –°—Ç–∞—Ä—ã–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏ (–¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–≤—è–∑–∫–∏)
- ‚ùå –¢–æ–≤–∞—Ä–∞–º–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç—å `fix-product-cabinets-v2.mjs` –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤.

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥—É—é

1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å Prisma middleware (–≤–∞—Ä–∏–∞–Ω—Ç 2)
2. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å fix —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ UI –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ (–µ—Å–ª–∏ –Ω–µ—Ç –∫–∞–±–∏–Ω–µ—Ç–æ–≤ - –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)

–¢–æ–≥–¥–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥–µ—Ç** —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã! üéâ
