# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π

## –ü—Ä–æ–±–ª–µ–º—ã
–°–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–æ–ª—É—á–∞–ª–∞ –¥–∞–Ω–Ω—ã–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏—è—Ö –∏–∑-–∑–∞ —Ç—Ä–µ—Ö –æ—à–∏–±–æ–∫:

1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ `/adv/v1/promotion/adverts`**
   - –û—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å: `[{id: 1234567}, {id: 23456}]` (–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤)
   - –û–∂–∏–¥–∞–ª–æ—Å—å: `[1234567, 23456]` (–º–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª)
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –û—à–∏–±–∫–∞ 400 "Invalid Advert: json: cannot unmarshal object into Go value of type int"

2. **–ù–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏—Å—å –∫–∞–º–ø–∞–Ω–∏–∏ —Å —Ä—É—á–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π (—Ç–∏–ø 9)**
   - Endpoint `/adv/v1/promotion/adverts` —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–∏–ø–æ–≤ 4-8
   - –ö–∞–º–ø–∞–Ω–∏–∏ —Å —Ç–∏–ø–æ–º 9 —Ç—Ä–µ–±—É—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint `/adv/v0/auction/adverts`
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ —Å —Ä—É—á–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å

3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ `/adv/v3/fullstats`**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è: `POST` —Å body
   - –¢—Ä–µ–±—É–µ—Ç—Å—è: `GET` —Å query –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –û—à–∏–±–∫–∞ 405 "method not allowed"

## –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ (—Å—Ç—Ä–æ–∫–∞ 694)
```typescript
// –ë–´–õ–û:
body: JSON.stringify(batch.map(id => ({ id })))

// –°–¢–ê–õ–û:
body: JSON.stringify(batch) // –ü—Ä–æ—Å—Ç–æ –º–∞—Å—Å–∏–≤ ID
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π —Å —Ä—É—á–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π (—Å—Ç—Ä–æ–∫–∏ 654-778)

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞–º–ø–∞–Ω–∏–π —á–µ—Ä–µ–∑ `/adv/v1/promotion/count`
2. –†–∞–∑–¥–µ–ª—è–µ–º ID –ø–æ —Ç–∏–ø–∞–º:
   - `campaignIds` - —Ç–∏–ø—ã 4-8 (—Å—Ç–∞—Ä—ã–µ —Ç–∏–ø—ã + –µ–¥–∏–Ω–∞—è —Å—Ç–∞–≤–∫–∞)
   - `type9Ids` - —Ç–∏–ø 9 (—Ä—É—á–Ω–∞—è —Å—Ç–∞–≤–∫–∞)
3. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏:
   - –¢–∏–ø—ã 4-8: `/adv/v1/promotion/adverts` (POST —Å –º–∞—Å—Å–∏–≤–æ–º ID)
   - –¢–∏–ø 9: `/adv/v0/auction/adverts?ids=X,Y,Z&statuses=-1,4,7,8,9,11` (GET)
4. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–∞–º–ø–∞–Ω–∏–π —Ç–∏–ø–∞ 9 –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

**–ó–∞–ø—Ä–æ—Å –∫–∞–º–ø–∞–Ω–∏–π —Å —Ä—É—á–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π:**
```typescript
GET /adv/v0/auction/adverts?ids=27673276,19696842&statuses=-1,4,7,8,9,11
```

**–°—Ç–∞—Ç—É—Å—ã:**
- `-1` - —É–¥–∞–ª–µ–Ω–∞
- `4` - –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–ø—É—Å–∫—É
- `7` - –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ (–Ω—É–∂–Ω–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏)
- `8` - –æ—Ç–º–µ–Ω–µ–Ω–∞
- `9` - –∞–∫—Ç–∏–≤–Ω–∞
- `11` - –Ω–∞ –ø–∞—É–∑–µ

**–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞:**
```typescript
{
  advertId: adv.id,
  name: adv.settings?.name,
  status: adv.status,
  type: 9,
  paymentType: adv.settings?.payment_type, // 'cpc' –∏–ª–∏ 'cpm'
  startTime: adv.timestamps?.started,
  endTime: adv.timestamps?.deleted,
  autoParams: {
    nms: adv.nm_settings?.map(nm => nm.nm_id), // –¢–æ–≤–∞—Ä—ã –≤ –∫–∞–º–ø–∞–Ω–∏–∏
    subject: adv.nm_settings?.[0]?.subject // –ö–∞—Ç–µ–≥–æ—Ä–∏—è
  }
}
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Å—Ç—Ä–æ–∫–∏ 828-857)

**–ë—ã–ª–æ:**
```typescript
const statsResponse = await fetch(
  'https://advert-api.wildberries.ru/adv/v3/fullstats',
  {
    method: 'POST',
    body: JSON.stringify(relevantCampaigns.map(c => ({
      id: c.advertId,
      dates: { from: startDate, to: endDate }
    })))
  }
);
```

**–°—Ç–∞–ª–æ:**
```typescript
const campaignIds = relevantCampaigns.map(c => c.advertId).join(',');
const statsUrl = `https://advert-api.wildberries.ru/adv/v3/fullstats?from=${startDate}&to=${endDate}&ids=${campaignIds}`;

const statsResponse = await fetch(statsUrl, {
  method: 'GET',
  headers: {
    'Authorization': apiToken,
    'Accept': 'application/json'
  }
});
```

**–§–æ—Ä–º–∞—Ç URL:**
```
GET /adv/v3/fullstats?from=2025-10-30&to=2025-11-05&ids=27673276,20377168
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
üîç –ó–∞–ø—Ä–æ—Å –í–°–ï–• –∫–∞–º–ø–∞–Ω–∏–π —á–µ—Ä–µ–∑ /count...
‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ID –∫–∞–º–ø–∞–Ω–∏–π: 27 (–≤—Å–µ–≥–æ: 27)
üì§ –ó–∞–ø—Ä–æ—Å –¥–µ—Ç–∞–ª–µ–π –±–∞—Ç—á–∞ 1: ID=[19696842, 20377168, ...]
üì• –û—Ç–≤–µ—Ç /adverts: status=400
‚ùå /adverts –æ—à–∏–±–∫–∞ 400: {"error":"Invalid Advert: json: cannot unmarshal object into Go value of type int"}
üîé –ù–∞–π–¥–µ–Ω–æ –∫–∞–º–ø–∞–Ω–∏–π –≤—Å–µ–≥–æ: 0
‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ".
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
üîç –ó–∞–ø—Ä–æ—Å –í–°–ï–• –∫–∞–º–ø–∞–Ω–∏–π —á–µ—Ä–µ–∑ /count...
‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ID –∫–∞–º–ø–∞–Ω–∏–π: 16 (—Ç–∏–ø 4-8), 11 (—Ç–∏–ø 9 - —Ä—É—á–Ω–∞—è —Å—Ç–∞–≤–∫–∞), –≤—Å–µ–≥–æ: 27
üì§ –ó–∞–ø—Ä–æ—Å –¥–µ—Ç–∞–ª–µ–π –±–∞—Ç—á–∞ 1 (—Ç–∏–ø 4-8): ID=[19696842, 20377168, ...]
üì• –û—Ç–≤–µ—Ç /adverts: status=200
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∫–∞–º–ø–∞–Ω–∏–π (—Ç–∏–ø 4-8): 16
üì§ –ó–∞–ø—Ä–æ—Å –∫–∞–º–ø–∞–Ω–∏–π —Å —Ä—É—á–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π (—Ç–∏–ø 9): 11 —à—Ç
üì• –û—Ç–≤–µ—Ç /auction/adverts: status=200
üì¶ –ü–æ–ª—É—á–µ–Ω–æ –∫–∞–º–ø–∞–Ω–∏–π —Å —Ä—É—á–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π: 11
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∫–∞–º–ø–∞–Ω–∏–π (—Ç–∏–ø 9): 11
üîé –ù–∞–π–¥–µ–Ω–æ –∫–∞–º–ø–∞–Ω–∏–π –≤—Å–µ–≥–æ: 27
üìã –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞–º–ø–∞–Ω–∏–π:
   - ID: 27673276, –°—Ç–∞—Ç—É—Å: 11, –¢–æ–≤–∞—Ä—ã: [356956444], –ö–∞—Ç–µ–≥–æ—Ä–∏—è: 69
   ...
üéØ –ù–∞–π–¥–µ–Ω–∞ –∫–∞–º–ø–∞–Ω–∏—è 27673276 (–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è, —Ç–∏–ø 8)
‚úÖ –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è –∫–∞–º–ø–∞–Ω–∏—è: ID=27673276, —Ç–æ–≤–∞—Ä=true, –∫–∞—Ç–µ–≥–æ—Ä–∏—è=true
üì§ –ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–º–ø–∞–Ω–∏–π: 2 —à—Ç
üì¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π –ø–æ–ª—É—á–µ–Ω–∞: 2 –∫–∞–º–ø–∞–Ω–∏–π
   –ö–∞–º–ø–∞–Ω–∏—è 27673276: –ø—Ä–æ—Å–º–æ—Ç—Ä—ã=1250, –∫–ª–∏–∫–∏=85, –∑–∞–∫–∞–∑—ã=3, CPM=250
   –ö–∞–º–ø–∞–Ω–∏—è 20377168: –ø—Ä–æ—Å–º–æ—Ç—Ä—ã=450, –∫–ª–∏–∫–∏=22, –∑–∞–∫–∞–∑—ã=1, CPM=180
```

## –¢–∏–ø—ã –∫–∞–º–ø–∞–Ω–∏–π WB

| –¢–∏–ø | –ù–∞–∑–≤–∞–Ω–∏–µ | Endpoint | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|-----|----------|----------|------------|
| 4 | –í –∫–∞—Ç–∞–ª–æ–≥–µ | `/adv/v1/promotion/adverts` | –£—Å—Ç–∞—Ä–µ–≤—à–∏–π |
| 5 | –í –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–æ–≤–∞—Ä–∞ | `/adv/v1/promotion/adverts` | –£—Å—Ç–∞—Ä–µ–≤—à–∏–π |
| 6 | –í –ø–æ–∏—Å–∫–µ | `/adv/v1/promotion/adverts` | –£—Å—Ç–∞—Ä–µ–≤—à–∏–π |
| 7 | –í —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö | `/adv/v1/promotion/adverts` | –£—Å—Ç–∞—Ä–µ–≤—à–∏–π |
| 8 | –ï–¥–∏–Ω–∞—è —Å—Ç–∞–≤–∫–∞ | `/adv/v1/promotion/adverts` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è |
| 9 | –†—É—á–Ω–∞—è —Å—Ç–∞–≤–∫–∞ | `/adv/v0/auction/adverts` | **–¢—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π API** |

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ó–∞–ø—Ä–æ—Å –∫–∞–º–ø–∞–Ω–∏–π –æ–¥–∏–Ω —Ä–∞–∑

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–ø—Ä–æ—Å –∫ `/adv/v1/promotion/count` –∏ `/adv/v1/promotion/adverts` –≤—ã–ø–æ–ª–Ω—è–ª—Å—è **–≤ –∫–∞–∂–¥–æ–π –Ω–µ–¥–µ–ª–µ** (–¥–æ 24 —Ä–∞–∑), —Ö–æ—Ç—è –¥–∞–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–π –Ω–µ –º–µ–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –Ω–µ–¥–µ–ª—è–º–∏.

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `fetchAllCampaigns()` –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑** –ø–µ—Ä–µ–¥ —Ü–∏–∫–ª–æ–º –Ω–µ–¥–µ–ª—å:

```typescript
// –ü–æ–ª—É—á–∞–µ–º –í–°–ï –∫–∞–º–ø–∞–Ω–∏–∏ –æ–¥–∏–Ω —Ä–∞–∑ (–Ω–µ –≤ –∫–∞–∂–¥–æ–π –Ω–µ–¥–µ–ª–µ!)
const allCampaigns = await fetchAllCampaigns(apiToken);

// –ò—â–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–µ–ª—è –∑–∞ –Ω–µ–¥–µ–ª–µ–π –Ω–∞–∑–∞–¥
while (weeksSearched < maxWeeksBack && totalDataPoints < targetDataPoints) {
  const weekData = await fetchWeekData(
    apiToken, nmId, subjectId, startDateStr, endDateStr,
    allCampaigns // –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏
  );
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í–º–µ—Å—Ç–æ 24 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API - —Ç–æ–ª—å–∫–æ **1 –∑–∞–ø—Ä–æ—Å**
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ ~24 —Ä–∞–∑–∞
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ WB API
- –ú–µ–Ω—å—à–µ —Ä–∏—Å–∫–∞ –ø–æ–ª—É—á–∏—Ç—å 429 (rate limit)

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã
- `src/app/api/products/[id]/smart-optimization-data/route.ts`
  - –°—Ç—Ä–æ–∫–∏ 207-334: –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `fetchAllCampaigns()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∫–∞–º–ø–∞–Ω–∏–π –æ–¥–∏–Ω —Ä–∞–∑
  - –°—Ç—Ä–æ–∫–∞ 75: –í—ã–∑–æ–≤ `fetchAllCampaigns()` –ø–µ—Ä–µ–¥ —Ü–∏–∫–ª–æ–º –Ω–µ–¥–µ–ª—å
  - –°—Ç—Ä–æ–∫–∞ 343: –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `allCampaigns` –≤ `fetchWeekData()`
  - –°—Ç—Ä–æ–∫–∏ 767-778: –£–ø—Ä–æ—â–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞–º–ø–∞–Ω–∏–π (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–æ–≤–∞—Ä–∞ —Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–µ–π
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   - `‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ID –∫–∞–º–ø–∞–Ω–∏–π: X (—Ç–∏–ø 4-8), Y (—Ç–∏–ø 9 - —Ä—É—á–Ω–∞—è —Å—Ç–∞–≤–∫–∞)`
   - `‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∫–∞–º–ø–∞–Ω–∏–π (—Ç–∏–ø 4-8): X`
   - `‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∫–∞–º–ø–∞–Ω–∏–π (—Ç–∏–ø 9): Y`
   - `üîé –ù–∞–π–¥–µ–Ω–æ –∫–∞–º–ø–∞–Ω–∏–π –≤—Å–µ–≥–æ: X+Y`
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ (—Å—Ç–∞—Ç—É—Å 7) –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è

## –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é WB
- Promotion API: https://dev.wildberries.ru/swagger/promotion
- `/adv/v1/promotion/count` - –°–ø–∏—Å–∫–∏ –∫–∞–º–ø–∞–Ω–∏–π
- `/adv/v1/promotion/adverts` - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–º–ø–∞–Ω–∏—è—Ö (—Ç–∏–ø 4-8)
- `/adv/v0/auction/adverts` - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–º–ø–∞–Ω–∏—è—Ö —Å —Ä—É—á–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π (—Ç–∏–ø 9)
